CONTRACT_TYPE
{
	name = kumTestMissionSubmarine

	title = "Destroy a submarine target"
	genericTitle = "Destroy a submarine target"

	group = munistorumTestOps
	agent = komUniMun

	description = "It has recently come to our attention that we have many weapons lying around, some which we cannot even confirm are still functional, that's where you come in." + "\n\nMission Latitude: " + @titleLat + "\nMission Longitude: " + @titleLon
	genericDescription = "It has recently come to our attention that we have many weapons lying around, some which we cannot even confirm are still functional, that's where you come in."

	topic = Weapons
	subject = Experiment

	synopsis = "Test some hardware while destroying a submarine target."

	completedMessage = "Success! The staff at our facility is overjoyed with the data!"

	minExpiry = 0.0
	maxExpiry = 0.0

	cancellable = true
	declinable = true

	targetBody = HomeWorld()

	maxCompletions = 0
	maxSimultaneous = 1

	// Data node for the rewards
	DATA
	{
		type = double

		science = 1 * Random(0.5, 2.2)
		reputation = 2 * Random(0.8, 2.0)
		funds = 4000 * Random(0.8, 1.2)
	}

	// Name Safety
	DATA
	{
		type = int

		nameAppend = Random(0, 65535)

		hidden = true
	}

	// Target Names
	DATA
	{
		type = string
		title = "Target vessels"

		targetVessel = "Target Submarine" + " ID: " + @/nameAppend
	}

	// Vehicle Lists
	DATA
	{
		type = List<string>

		targetList = @/munistorumDataStore:targetSubmarineList
	}

	// Test Part
	DATA
	{
		type = AvailablePart

		testPart = AllParts().Where(b => b.IsUnlocked() && (b.Description().Contains("TRP-Testable"))).Random()

		hidden = true
	}

	// Is part testing a parameter?
	DATA
	{
		type = int

		partTestValue = Random(0,1)

		hidden = true
	}

	// Vehicle Positions
	DATA
	{
		type = double

		squadLat = Random(1.26, -0.76)
		squadLon = Random(-72.6, -71.62)
		squadAlt = Random(-50.0, -500.0)
		squadHdg = Random(0.0, 360.0)
	}

	// Title Coordinates
	DATA
	{
		type = double

		titleLat = Round(@squadLat)
		titleLon = Round(@squadLon)
	}

	// Requirement node for contract prerequisites
	REQUIREMENT
	{
		name = CompleteContract
		type = CompleteContract
		contractType = kumRequiredUav
	}

	// Value definitions
	rewardScience = @/science
	rewardReputation = @/reputation
	rewardFunds = @/funds

	failureReputation = @/reputation / 4
	failureFunds = @/funds / 8
	advanceFunds = @/funds / 4

	// Behaviour such as vessel location, name etc

	// Target
	BEHAVIOUR
	{
		name = SpawnTarget
		type = SpawnVessel
		deferVesselCreation = true

		VESSEL
		{
			name = "Target Submarine"
			craftURL = "ContractPacks/KUM/Assets/Ships/target_submarine.craft"
			flagURL = Squad/Flags/retro
			vesselType = Unknown
			owned = false
			targetBody = HomeWorld()

			lat = @/squadLat
			lon = @/squadLon
			alt = @/squadAlt

			heading = @/squadHdg
		}
	}

	// Destroy all mission vessels for safety
	BEHAVIOUR
	{
		name = ContingencyCleanup
		type = DestroyVessel

		onState = CONTRACT_COMPLETED

		vessel = @/targetVessel
	}

	// Parameters for completing the contract
	PARAMETER
	{
		name = TestingSequence
		type = PartTest

		title = "Approach the target for testing purposes"
		completedMessage = "Tests complete, destroy the target!"

		rewardScience = @/science
		rewardReputation = @/reputation
		rewardFunds = (@/funds / 2)

		failureReputation = 0.0
		failureFunds = 0.0

		optional = true

		part = @/testPart

		REQUIREMENT
		{
			name = Expression
			type = Expression

			expression = @/partTestValue == 1
		}

		PARAMETER
		{
			name = HasTestPart
			type = PartValidation

			title = "Have at least one " + @/testPart + " on your vehicle"

			part = @/testPart
			minCount = 1
		}

		PARAMETER
		{
			name = RendezvousCraft
			type = Rendezvous

			title = "Approach the target within 100 meters of distance"
			notes = "Rendezvous should allow us to test the hardware."

			vessel = @/targetVessel

			disableOnStateChange = true

			distance = 100.0
		}

		PARAMETER
		{
			name = TestDuration
			type = Duration

			preWaitText = "Rendezvous for equipment testing"
			waitingText = "Testing equipment..."
			completionText = "Equipment testing"

			completeInSequence = true

			duration = 10s

			startCriteria = PARAMETER_COMPLETION
			parameter = RendezvousCraft
		}
	}

	// Combat parameters
	PARAMETER
	{
		name = CombatSequence
		type = Sequence

		title = "Destroy the target"

		hiddenParameter = LandBase
		hiddenParameter = RecoverBase

		PARAMETER
		{
			name = DestroyCraft
			type = TargetDestroyed

			title = "Destroy the submarine target"

			vessel = @/targetVessel
		}

		// Parameter for recovering the vessel after the mission
		PARAMETER
		{
			name = ToBase
			type = All

			title = "Land the testbed vessel and recover it safely on Kerbin"

			disableOnStateChange = true
			completeInSequence = true

			PARAMETER
			{
				name = LandBase
				type = ReturnHome

				title = "Stop the testbed vessel on the surface"
		}

		PARAMETER
		{
				name = RecoverBase
			type = RecoverVessel

				title = "Recover the vessel"
				completedMessage = "The testbed vessel was successfully recovered!"
			}
		}
	}
}
